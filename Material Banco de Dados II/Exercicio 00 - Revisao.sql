CREATE DATABASE REVISAO

USE REVISAO

DROP TABLE TB_CLIENTE;
DROP TABLE TB_DVD ;
DROP TABLE TB_LOCACAO;


CREATE TABLE TB_DVD(
	CD_DVD	INT		NOT NULL  PRIMARY KEY, 
	TITULO 	VARCHAR(60)	NOT NULL,
	CATEGORIA	VARCHAR(20) NOT NULL
)

CREATE TABLE TB_CLIENTE(
	CD_CLIENTE	INT   NOT NULL PRIMARY KEY,
	NM_CLIENTE  VARCHAR(30) NOT NULL
)

CREATE TABLE TB_LOCACAO(
	CD_CLIENTE	INT   NOT NULL,
	CD_DVD	INT		NOT NULL,
	DT_LOCACAO DATE	NOT NULL,
	VALOR	DECIMAL(10,2) NOT NULL,
	DT_DEVOLUCAO DATE NULL
	FOREIGN KEY (CD_CLIENTE) REFERENCES TB_CLIENTE(CD_CLIENTE),
	FOREIGN KEY (CD_DVD)  REFERENCES TB_DVD(CD_DVD),
	PRIMARY KEY(CD_DVD,CD_CLIENTE,DT_LOCACAO)
)
--INSERT
INSERT INTO TB_DVD (CD_DVD ,titulo, categoria)
VALUES(1,'CINDERELA', 'INFANTIL')

INSERT INTO TB_DVD (CD_DVD ,titulo, categoria)
VALUES(2,'DETONA RALPH', 'INFANTIL')

INSERT INTO TB_DVD (CD_DVD ,titulo, categoria)
VALUES(3,'MEU MALVADO FAVORITO', 'INFANTIL')

INSERT INTO TB_DVD (CD_DVD, titulo, categoria)
VALUES (4,'VELOZES E FURIOSOS 7', 'AÇÃO'),
       (5,'GOLPE DUPLO', 'COMÉDIA')

-- Tabela TB_CLIENTE

INSERT INTO TB_CLIENTE (CD_CLIENTE ,nm_cliente)
VALUES (1,'JOÃO'),
       (2,'CARLOS'),
       (3,'ROBERTA'),
       (4,'RICARDO'),
       (5,'PEDRO')

-- Tabela TB_LOCACAO

INSERT INTO TB_LOCACAO (cd_cliente, cd_dvd, dt_locacao, valor, dt_devolucao)
VALUES (1,1,'20180506',5.00,NULL),
       (1,4,'20180406',10.00,NULL), 
       (2,2,'20180506',5.00,NULL),
       (1,3,'20180406',5.00,NULL),
       (3,1,'20180606',5.00,NULL),
       (3,4,'20180406',5.00,NULL),
       (4,1,'20180406',5.00,NULL),
       (4,2,'20180406',5.00,NULL),
       (4,4,'20180606',5.00,NULL)



--1

SELECT 
	td.TITULO,
	tc.NM_CLIENTE 
FROM 
	TB_LOCACAO tl
JOIN
	TB_CLIENTE tc ON tc.CD_CLIENTE = tl.CD_CLIENTE 
JOIN 
	TB_DVD td ON td.CD_DVD = tl.CD_DVD 

--2

SELECT 
	COUNT(td.TITULO),
	td.TITULO 
FROM 
	TB_LOCACAO tl
JOIN 
	TB_DVD td ON td.CD_DVD = tl.CD_DVD 
GROUP BY 
	td.TITULO 

--3

SELECT 
	COUNT(td.CATEGORIA),
	td.CATEGORIA 
FROM 
	TB_LOCACAO tl
JOIN 
	TB_DVD td ON td.CD_DVD = tl.CD_DVD 
GROUP BY 
	td.CATEGORIA 
HAVING 
	COUNT(td.CATEGORIA) > 4
	
--4
	

SELECT 
	COUNT(td.CATEGORIA),
	td.CATEGORIA 
FROM 
	TB_LOCACAO tl
JOIN 
	TB_DVD td ON td.CD_DVD = tl.CD_DVD 
WHERE 
	tl.DT_DEVOLUCAO is null
GROUP BY 
	td.CATEGORIA 
	
--5
	
SELECT 
	COUNT(tl.DT_LOCACAO),
	td.TITULO 
FROM 
	TB_LOCACAO tl
JOIN 
	TB_DVD td ON td.CD_DVD = tl.CD_DVD 
WHERE 
	YEAR(tl.DT_LOCACAO) = 2018
GROUP BY 
	td.TITULO 
HAVING 
	COUNT(tl.DT_LOCACAO) > 2
	
--6
SELECT 
	tc.NM_CLIENTE,
	COUNT(tl.CD_CLIENTE ) as 'Quantidade Alugueis'
FROM 
	TB_CLIENTE tc
left JOIN
	TB_LOCACAO tl ON tc.CD_CLIENTE = tl.CD_CLIENTE 
GROUP BY 
	tc.NM_CLIENTE 

--7
SELECT 
	tc.NM_CLIENTE,
	COUNT(tl.CD_CLIENTE )
FROM 
	TB_CLIENTE tc
left JOIN
	TB_LOCACAO tl ON tc.CD_CLIENTE = tl.CD_CLIENTE 
GROUP BY 
	tc.NM_CLIENTE 
HAVING 
	COUNT(tl.CD_CLIENTE) = 0
	


	
	
	