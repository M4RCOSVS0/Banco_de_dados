-- lab 07 

CREATE DATABASE lab07

use lab07

DROP TABLE TB_SOLICITACAO
DROP TABLE TB_TECNICO
DROP TABLE TB_FUNCIONARIO
DROP TABLE TB_SETOR
DROP TABLE TB_DEPARTAMENTO


CREATE TABLE TB_DEPARTAMENTO (
  CD_DEPARTAMENTO INT NOT NULL PRIMARY KEY,
  NM_DEPARTAMENTO VARCHAR(40) NOT NULL
)

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (10,'TI')

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (20,'RH')

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (30,'MA')



CREATE TABLE TB_SETOR (
  CD_SETOR INT NOT NULL PRIMARY KEY,
  NM_SETOR VARCHAR(40) NOT NULL,
  NM_GERENTE VARCHAR(50) NOT NULL,
  CD_DEPARTAMENTO INT NOT NULL
)

ALTER TABLE TB_SETOR ADD CONSTRAINT FK_SETOR 
FOREIGN KEY (CD_DEPARTAMENTO) REFERENCES TB_DEPARTAMENTO(CD_DEPARTAMENTO)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR,NM_GERENTE, CD_DEPARTAMENTO)
VALUES (100,'SETOR 100','JOSE CARLOS',10)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (200,'SETOR 200','JOSEFA', 20)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (201,'SETOR 201','PAULO SILVA', 20)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (202,'SETOR 202','RICARDO ARAUJO', 20)


CREATE TABLE TB_FUNCIONARIO (
  MATRICULA INT NOT NULL PRIMARY KEY,
  NM_FUNCIONARIO VARCHAR(40) NOT NULL,
  SEXO VARCHAR(1) NOT NULL,
  CD_SETOR INT NULL
)

ALTER TABLE TB_FUNCIONARIO ADD CONSTRAINT FK_FUNCIONARIO 
FOREIGN KEY (CD_SETOR) REFERENCES TB_SETOR(CD_SETOR)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (1,'JOAO','M',100)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (2,'MARIA','F',200)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (3,'PEDRO','M',200)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (4,'RICARDO','M',201)

CREATE TABLE TB_TECNICO (
  CD_TECNICO INT NOT NULL PRIMARY KEY,
  NM_TECNICO VARCHAR(40) NOT NULL,
)

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (101,'RITA')

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (102,'PATRICIA')

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (103,'JOANA')


CREATE TABLE TB_SOLICITACAO (
  CD_SOLICITACAO INT NOT NULL PRIMARY KEY,
  MATRICULA INT NOT NULL,
  CD_TECNICO INT NULL,
  DATA_ABERTURA DATETIME NOT NULL,
  DESCRICAO VARCHAR(50) NOT NULL,
  DATA_FECHAMENTO DATETIME NULL,
  DESCRICAO_FECHAMENTO VARCHAR(50) NULL
)

ALTER TABLE TB_SOLICITACAO ADD CONSTRAINT FK_SOLICITACAO_FUNCIONARIO 
FOREIGN KEY (MATRICULA) REFERENCES TB_FUNCIONARIO(MATRICULA)

ALTER TABLE TB_SOLICITACAO ADD CONSTRAINT FK_SOLICITACAO_TECNICO 
FOREIGN KEY (CD_TECNICO) REFERENCES TB_TECNICO(CD_TECNICO)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(1, 1,101,'20190620','IMPRESSORA COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(2, 2,101,'20190620','MS WORD COM PROBLEMA','20190620', 'REINSTALADO')

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(3, 3,102,'20190620','MOUSE COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(4, 4,102,'20190620','MONITOR COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(5, 1,101,'20190622','MICRO TRAVANDO',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(6, 2,101,'20190622','MS EXCEL COM PROBLEMA',NULL, NULL)


SELECT * FROM TB_SOLICITACAO
SELECT * FROM  TB_TECNICO
SELECT * FROM  TB_FUNCIONARIO
SELECT * FROM  TB_SETOR
SELECT * FROM  TB_DEPARTAMENTO

--A
SELECT
    TD.CD_DEPARTAMENTO,
    TD.NM_DEPARTAMENTO,
    TS.NM_SETOR,
    TS.NM_GERENTE
FROM
    TB_DEPARTAMENTO TD
LEFT JOIN
    TB_SETOR TS on TD.CD_DEPARTAMENTO = TS.CD_DEPARTAMENTO

--B
SELECT
    TD.NM_DEPARTAMENTO,
    TS.CD_SETOR,
    TS.NM_GERENTE,
    TF.NM_FUNCIONARIO
FROM
    TB_SETOR TS
LEFT JOIN
    TB_FUNCIONARIO TF on TS.CD_SETOR = TF.CD_SETOR
RIGHT JOIN
    TB_DEPARTAMENTO TD on TS.CD_DEPARTAMENTO = TD.CD_DEPARTAMENTO

--C
SELECT
    TS.NM_GERENTE,
    TF.NM_FUNCIONARIO,
    TF.MATRICULA
FROM
    TB_SETOR TS
JOIN
    TB_FUNCIONARIO TF on TS.CD_SETOR = TF.CD_SETOR

--D
SELECT
    TF.NM_FUNCIONARIO,
    COUNT(TS.MATRICULA)
FROM
    TB_SOLICITACAO TS
JOIN
    TB_FUNCIONARIO TF on TS.MATRICULA = TF.MATRICULA
GROUP BY
    TF.NM_FUNCIONARIO

--E
SELECT
    TF.NM_FUNCIONARIO,
    COUNT(TS.MATRICULA)
FROM
    TB_SOLICITACAO TS
JOIN
    TB_FUNCIONARIO TF on TS.MATRICULA = TF.MATRICULA
GROUP BY
    TF.NM_FUNCIONARIO

--F
SELECT
    T.NM_SETOR,
    COUNT(TS.MATRICULA)
FROM
    TB_SOLICITACAO TS
JOIN
    TB_FUNCIONARIO TF on TS.MATRICULA = TF.MATRICULA
JOIN
    TB_SETOR T on TF.CD_SETOR = T.CD_SETOR
GROUP BY
    T.NM_SETOR

--G
SELECT
    TD.NM_DEPARTAMENTO,
    COUNT(TS.MATRICULA)
FROM
    TB_SOLICITACAO TS
JOIN
    TB_FUNCIONARIO TF on TS.MATRICULA = TF.MATRICULA
JOIN
    TB_SETOR T on TF.CD_SETOR = T.CD_SETOR
JOIN
    TB_DEPARTAMENTO TD on T.CD_DEPARTAMENTO = TD.CD_DEPARTAMENTO
GROUP BY
    TD.NM_DEPARTAMENTO
HAVING
    COUNT(TS.MATRICULA) > 2

--H
SELECT
    TT.NM_TECNICO,
    TF.MATRICULA,
    TF.NM_FUNCIONARIO,
    TS.DATA_ABERTURA,
    TS.DESCRICAO,
    TS.DATA_FECHAMENTO
FROM
    TB_SOLICITACAO TS
JOIN
    TB_FUNCIONARIO TF on TS.MATRICULA = TF.MATRICULA
JOIN
    TB_TECNICO TT on TS.CD_TECNICO = TT.CD_TECNICO
WHERE
    TS.DATA_FECHAMENTO IS NOT NULL

--I
SELECT
    NM_TECNICO
FROM
    TB_TECNICO TT
WHERE
    NOT EXISTS (SELECT 1 FROM TB_SOLICITACAO TS WHERE TT.CD_TECNICO = TS.CD_TECNICO);