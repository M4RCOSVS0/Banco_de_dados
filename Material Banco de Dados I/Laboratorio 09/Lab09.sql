-- Lab09

CREATE DATABASE lab09

use lab09


CREATE TABLE TB_PROPRIETARIO (
    CD_PROPRIETARIO     int NOT NULL PRIMARY KEY,
    NM_PROPRIETARIO 	varchar(50) NOT NULL,
    TELEFONE		varchar(15)
)


-- Dados de PROPRIETARIOS

INSERT INTO TB_PROPRIETARIO (CD_PROPRIETARIO, NM_PROPRIETARIO,TELEFONE)
VALUES(1,'ANA MARIA DE JESUS','3231-7867')

INSERT INTO TB_PROPRIETARIO (CD_PROPRIETARIO, NM_PROPRIETARIO,TELEFONE)
VALUES(2,'JOSE RICARDO','5673-4444')

INSERT INTO TB_PROPRIETARIO (CD_PROPRIETARIO, NM_PROPRIETARIO,TELEFONE)
VALUES(3,'PAULO SILVA','3454-1983')


CREATE TABLE TB_RACA (
    CD_RACA 		int NOT NULL PRIMARY KEY,
    NM_RACA 		varchar(50) NOT NULL,
    PORTE  	        varchar(10) NOT NULL,
    PAIS_DE_ORIGEM 	varchar(50)
)


INSERT INTO TB_RACA (CD_RACA, NM_RACA, PORTE, PAIS_DE_ORIGEM)
VALUES (1, 'PASTOR ALEMAO', 'GRANDE', 'ALEMANHA')

INSERT INTO TB_RACA (CD_RACA, NM_RACA, PORTE, PAIS_DE_ORIGEM)
VALUES (2, 'DOBERMAN', 'GRANDE', 'ALEMANHA')

INSERT INTO TB_RACA (CD_RACA, NM_RACA, PORTE, PAIS_DE_ORIGEM)
VALUES (3, 'PIT BULL', 'MEDIO', 'INGLATERRA')


CREATE TABLE TB_ANIMAL (
    CD_ANIMAL 			int NOT NULL PRIMARY KEY,
    NM_ANIMAL 			varchar(50) NOT NULL,
    SEXO		 	varchar(1) NOT NULL,
    DT_NASCIMENTO		datetime,
    CD_RACA			int      NOT NULL REFERENCES TB_RACA (CD_RACA),
    CD_PROPRIETARIO		int      NOT NULL REFERENCES TB_PROPRIETARIO (CD_PROPRIETARIO)
)


-- Dados de Animais

INSERT INTO TB_ANIMAL (CD_ANIMAL, NM_ANIMAL, SEXO, DT_NASCIMENTO, CD_RACA, CD_PROPRIETARIO)
VALUES (1, 'ROSSI', 'M', '20120812', 3, 1)

INSERT INTO TB_ANIMAL (CD_ANIMAL, NM_ANIMAL, SEXO, DT_NASCIMENTO, CD_RACA, CD_PROPRIETARIO)
VALUES (2, 'RAMBO', 'M', '20140701', 2, 1)

INSERT INTO TB_ANIMAL (CD_ANIMAL, NM_ANIMAL, SEXO, DT_NASCIMENTO, CD_RACA, CD_PROPRIETARIO)
VALUES (3, 'DOLLY', 'F', '20180315', 1, 1)

INSERT INTO TB_ANIMAL (CD_ANIMAL, NM_ANIMAL, SEXO, DT_NASCIMENTO, CD_RACA, CD_PROPRIETARIO)
VALUES (4, 'NEMO', 'M', '20160102', 1, 2)


CREATE TABLE TB_CONSULTA (
    CD_CONSULTA 		int NOT NULL,
    CD_ANIMAL			int NOT NULL,
    DT_CONSULTA			datetime NOT NULL,
    VALOR			numeric(15,2) NOT NULL,
    DS_CONSULTA			varchar(1000),
    DT_PROXIMA_CONSULTA		datetime,
    DS_PROXIMA_CONSULTA		varchar(1000)
)

ALTER TABLE TB_CONSULTA ADD CONSTRAINT PK_CONSULTA
PRIMARY KEY (CD_CONSULTA)

ALTER TABLE TB_CONSULTA ADD CONSTRAINT FK_CONSULTA_ANIMAL
FOREIGN KEY (CD_ANIMAL) REFERENCES TB_ANIMAL(CD_ANIMAL)

-- Dados de Consultas


INSERT INTO TB_CONSULTA (CD_CONSULTA, CD_ANIMAL, DT_CONSULTA, VALOR ,
                      DS_CONSULTA, DT_PROXIMA_CONSULTA, DS_PROXIMA_CONSULTA)
VALUES(1,1,'20121019', 30.00, 'PRIMEIRA CONSULTA',NULL, NULL)


INSERT INTO TB_CONSULTA (CD_CONSULTA, CD_ANIMAL, DT_CONSULTA, VALOR ,
                      DS_CONSULTA, DT_PROXIMA_CONSULTA, DS_PROXIMA_CONSULTA)
VALUES(2,1,'20130119', 60.00, 'PRIMEIRAS VACINAS',NULL, NULL)


INSERT INTO TB_CONSULTA (CD_CONSULTA, CD_ANIMAL, DT_CONSULTA, VALOR ,
                      DS_CONSULTA, DT_PROXIMA_CONSULTA, DS_PROXIMA_CONSULTA)
VALUES(3,2,'20150624', 30.00, 'PRIMEIRA CONSULTA',NULL, NULL)


INSERT INTO TB_CONSULTA (CD_CONSULTA, CD_ANIMAL, DT_CONSULTA, VALOR ,
                      DS_CONSULTA, DT_PROXIMA_CONSULTA, DS_PROXIMA_CONSULTA)
VALUES(4,2,'20150824', 60.00, 'PRIMEIRAS VACINAS',NULL, NULL)


SELECT * FROM TB_PROPRIETARIO
SELECT * FROM TB_RACA
SELECT * FROM TB_ANIMAL
SELECT * FROM TB_CONSULTA

--1
SELECT
    TP.NM_PROPRIETARIO,
    TA.NM_ANIMAL,
    TR.NM_RACA
FROM
    TB_PROPRIETARIO TP
LEFT JOIN
    TB_ANIMAL TA on TP.CD_PROPRIETARIO = TA.CD_PROPRIETARIO
LEFT JOIN
    TB_RACA TR on TA.CD_RACA = TR.CD_RACA

--2
SELECT
    TP.NM_PROPRIETARIO,
    COUNT(TC.CD_CONSULTA) TOTAL
FROM
    TB_PROPRIETARIO TP
JOIN
    TB_ANIMAL TA on TP.CD_PROPRIETARIO = TA.CD_PROPRIETARIO
JOIN
    TB_CONSULTA TC on TA.CD_ANIMAL = TC.CD_ANIMAL
GROUP BY
    TP.NM_PROPRIETARIO
HAVING
     COUNT(TC.CD_CONSULTA) > 2

--3
SELECT
    TR.CD_RACA,
    TR.NM_RACA,
    COUNT(TC.CD_CONSULTA)
FROM
    TB_ANIMAL TA
LEFT JOIN
    TB_RACA TR ON TA.CD_RACA = TR.CD_RACA
LEFT JOIN
    TB_CONSULTA TC on TA.CD_ANIMAL = TC.CD_ANIMAL
GROUP BY
    TR.CD_RACA, TR.NM_RACA

--4
SELECT
    TA.NM_ANIMAL
FROM
    TB_ANIMAL TA
LEFT JOIN
    TB_CONSULTA TC on TA.CD_ANIMAL = TC.CD_ANIMAL
WHERE TC.CD_CONSULTA IS NULL


--5
SELECT
    TA.NM_ANIMAL
FROM
    TB_ANIMAL TA
JOIN
    TB_CONSULTA TC on TA.CD_ANIMAL = TC.CD_ANIMAL
GROUP BY
    TA.NM_ANIMAL
HAVING
     COUNT(TC.CD_CONSULTA) >= ALL(
                                SELECT
                                    COUNT(C.CD_CONSULTA) TOTAL
                                FROM
                                    TB_ANIMAL A
                                JOIN
                                    TB_CONSULTA C on A.CD_ANIMAL = C.CD_ANIMAL
                                GROUP BY
                                    C.CD_CONSULTA
    )