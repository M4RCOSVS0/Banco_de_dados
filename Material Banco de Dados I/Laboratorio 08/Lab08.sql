-- Lab 08 


CREATE DATABASE lab08

use lab08


DROP TABLE TB_SOLICITACAO
DROP TABLE TB_TECNICO
DROP TABLE TB_FUNCIONARIO
DROP TABLE TB_SETOR
DROP TABLE TB_DEPARTAMENTO


CREATE TABLE TB_DEPARTAMENTO (
  CD_DEPARTAMENTO INT NOT NULL PRIMARY KEY,
  NM_DEPARTAMENTO VARCHAR(40) NOT NULL
)

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (10,'TI')

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (20,'RH')

INSERT INTO TB_DEPARTAMENTO (CD_DEPARTAMENTO, NM_DEPARTAMENTO)
VALUES (30,'MA')



CREATE TABLE TB_SETOR (
  CD_SETOR INT NOT NULL PRIMARY KEY,
  NM_SETOR VARCHAR(40) NOT NULL,
  NM_GERENTE VARCHAR(50) NOT NULL,
  CD_DEPARTAMENTO INT NOT NULL
)

ALTER TABLE TB_SETOR ADD CONSTRAINT FK_SETOR 
FOREIGN KEY (CD_DEPARTAMENTO) REFERENCES TB_DEPARTAMENTO(CD_DEPARTAMENTO)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR,NM_GERENTE, CD_DEPARTAMENTO)
VALUES (100,'SETOR 100','JOSE CARLOS',10)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (200,'SETOR 200','JOSEFA', 20)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (201,'SETOR 201','PAULO SILVA', 20)

INSERT INTO TB_SETOR (CD_SETOR, NM_SETOR, NM_GERENTE, CD_DEPARTAMENTO)
VALUES (202,'SETOR 202','RICARDO ARAUJO', 20)


CREATE TABLE TB_FUNCIONARIO (
  MATRICULA INT NOT NULL PRIMARY KEY,
  NM_FUNCIONARIO VARCHAR(40) NOT NULL,
  SEXO VARCHAR(1) NOT NULL,
  CD_SETOR INT NULL
)

ALTER TABLE TB_FUNCIONARIO ADD CONSTRAINT FK_FUNCIONARIO 
FOREIGN KEY (CD_SETOR) REFERENCES TB_SETOR(CD_SETOR)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (1,'JOAO','M',100)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (2,'MARIA','F',200)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (3,'PEDRO','M',200)

INSERT INTO TB_FUNCIONARIO (MATRICULA, NM_FUNCIONARIO, SEXO, CD_SETOR)
VALUES (4,'RICARDO','M',201)


CREATE TABLE TB_TECNICO (
  CD_TECNICO INT NOT NULL PRIMARY KEY,
  NM_TECNICO VARCHAR(40) NOT NULL,
)

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (101,'RITA')

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (102,'PATRICIA')

INSERT INTO TB_TECNICO (CD_TECNICO, NM_TECNICO)
VALUES (103,'JOANA')


CREATE TABLE TB_SOLICITACAO (
  CD_SOLICITACAO INT NOT NULL PRIMARY KEY,
  MATRICULA INT NOT NULL,
  CD_TECNICO INT NULL,
  DATA_ABERTURA DATETIME NOT NULL,
  DESCRICAO VARCHAR(50) NOT NULL,
  DATA_FECHAMENTO DATETIME NULL,
  DESCRICAO_FECHAMENTO VARCHAR(50) NULL
)

ALTER TABLE TB_SOLICITACAO ADD CONSTRAINT FK_SOLICITACAO_FUNCIONARIO 
FOREIGN KEY (MATRICULA) REFERENCES TB_FUNCIONARIO(MATRICULA)

ALTER TABLE TB_SOLICITACAO ADD CONSTRAINT FK_SOLICITACAO_TECNICO 
FOREIGN KEY (CD_TECNICO) REFERENCES TB_TECNICO(CD_TECNICO)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(1, 1,101,'20190620','IMPRESSORA COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(2, 2,101,'20190620','MS WORD COM PROBLEMA','20190620 ', 'REINSTALADO')

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(3, 3,102,'20190620','MOUSE COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(4, 4,102,'20190620','MONITOR COM PROBLEMA',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(5, 1,101,'20190622','MICRO TRAVANDO',NULL, NULL)

INSERT INTO TB_SOLICITACAO (CD_SOLICITACAO, MATRICULA,CD_TECNICO,DATA_ABERTURA,
                            DESCRICAO, DATA_FECHAMENTO, DESCRICAO_FECHAMENTO)
VALUES(6, 2,101,'20190622','MS EXCEL COM PROBLEMA',NULL, NULL)

--A
SELECT
    F.MATRICULA,
    F.NM_FUNCIONARIO
FROM
    TB_FUNCIONARIO F
WHERE
    F.MATRICULA IN (SELECT
                        S.MATRICULA
                    FROM
                        TB_SOLICITACAO S
                    WHERE
                        S.DATA_ABERTURA = '20190620')
    AND
    F.MATRICULA NOT IN (SELECT
                            S.MATRICULA
                        FROM
                            TB_SOLICITACAO S
                        WHERE
                            S.DATA_ABERTURA = '20190622');

--B
SELECT
    F.MATRICULA,
    F.NM_FUNCIONARIO,
    (SELECT
         COUNT(S.CD_SOLICITACAO)
    FROM
        TB_SOLICITACAO S
    WHERE
        S.MATRICULA = F.MATRICULA AND S.DATA_ABERTURA = '20190620') AS 'DIA 20',
        (SELECT
             COUNT(S.CD_SOLICITACAO)
        FROM
            TB_SOLICITACAO S
        WHERE
            S.MATRICULA = F.MATRICULA AND S.DATA_ABERTURA = '20190622') AS 'DIA 22'
FROM
    TB_FUNCIONARIO F;

--C
SELECT
    F.NM_FUNCIONARIO AS NOME,
    COUNT(TS.CD_SOLICITACAO) AS TOTAL
FROM
    TB_FUNCIONARIO F
LEFT JOIN
    TB_SOLICITACAO TS on F.MATRICULA = TS.MATRICULA
GROUP BY F.NM_FUNCIONARIO

UNION ALL

SELECT
    TT.NM_TECNICO AS NOME,
    COUNT(TS.CD_SOLICITACAO)  AS TOTAL
FROM
    TB_TECNICO TT
LEFT JOIN
    TB_SOLICITACAO TS on TT.CD_TECNICO = TS.CD_TECNICO
GROUP BY
    TT.NM_TECNICO

ORDER BY
    TOTAL DESC, NOME

--D
SELECT
    F.NM_FUNCIONARIO,
    COUNT(S.CD_SOLICITACAO) TOTAL
FROM
    TB_FUNCIONARIO F
LEFT JOIN
        TB_SOLICITACAO S ON (F.MATRICULA = S.MATRICULA)
GROUP BY
    F.NM_FUNCIONARIO
HAVING
    COUNT (S.CD_SOLICITACAO) >= ALL (
                                    SELECT
                                         COUNT(S.CD_SOLICITACAO)
				                    FROM
				                         TB_FUNCIONARIO F
				                    LEFT JOIN
				                             TB_SOLICITACAO S	ON (F.MATRICULA = S.MATRICULA)
				                    GROUP BY
				                        F.NM_FUNCIONARIO
				                    )

--E
SELECT
    F.NM_FUNCIONARIO,
    COUNT(S.CD_SOLICITACAO) TOTAL
FROM
    TB_FUNCIONARIO F
LEFT JOIN
        TB_SOLICITACAO S ON (F.MATRICULA = S.MATRICULA)
GROUP BY
    F.NM_FUNCIONARIO
HAVING
    COUNT (S.CD_SOLICITACAO) <= ALL (
                                    SELECT
                                         COUNT(S.CD_SOLICITACAO)
				                    FROM
				                         TB_FUNCIONARIO F
				                    LEFT JOIN
				                             TB_SOLICITACAO S	ON (F.MATRICULA = S.MATRICULA)
				                    GROUP BY
				                        F.NM_FUNCIONARIO
				                    )

